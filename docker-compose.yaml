version: "3.9"

services:
  webapp:
    build:
      dockerfile: prod.Dockerfile
      context: .
    image: webapp:latest
    restart: unless-stopped
    # Coolify g√®re le proxy, pas besoin d'exposer les ports
    command: gunicorn --workers=3 --bind 0.0.0.0:8000 --timeout 60 --access-logfile - --error-logfile - project.wsgi:application
    expose:
      - 8000
    # Coolify injecte automatiquement les variables d'environnement
    volumes:
      - sqlite_volume:/code/src/db
      - static_volume:/code/src/static_root
      - media_volume:/code/src/mediafiles
      # Coolify proxy config path
      - /data/coolify/proxy/dynamic:/code/src/dynamic
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  sqlite_volume:
  media_volume:
