# nixpacks.toml - Django (uv) + Vite (React/Tailwind avec bun)

# Force les providers : Python en premier (pour uv), puis Node pour bun/Vite
providers = ["python", "node"]

# Bun est supporté nativement par Nixpacks (super rapide !)
[variables]
NIXPACKS_NODE_VERSION = "20"  # Optionnel, mais stable pour bun
# NIXPACKS_UV_VERSION = "0.4.30"
NIXPACKS_PYTHON_VERSION = "3.12"

# Phases personnalisées pour contourner le bug uv
[phases.setup]
# Installe uv directement via le script officiel (rapide et fiable)
cmds = ["curl -LsSf https://astral.sh/uv/install.sh | sh -s -- --version 0.4.30"]

# Phase de build :
# 1. Build Vite avec bun (output dans ./static comme configuré dans vite.config.js)
# 2. Migrations Django
# 3. Collectstatic (WhiteNoise s'en occupera en prod)
[phases.build]
cmds = [
  "bun install",                  # Installe les deps frontend
  "bun run build",                # Équivalent à vite build → output dans ./static
  "uv sync --no-dev --frozen",  # Installe tes deps Python via uv
  "python manage.py migrate",
  "python manage.py collectstatic --noinput"
]

# Start : Gunicorn + WhiteNoise pour servir les statics (y compris ceux de Vite)
[start]
cmd = "gunicorn project.wsgi:application --bind 0.0.0.0:$PORT"  # Remplace vite_demo par le nom de ton projet Django